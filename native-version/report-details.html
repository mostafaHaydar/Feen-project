<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تفاصيل البلاغ - فين</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-cyan-50 font-['Cairo']">
    <!-- Background decoration -->
    <div class="absolute top-20 right-10 w-72 h-72 bg-gradient-to-br from-indigo-200/30 to-purple-200/30 rounded-full blur-3xl"></div>
    <div class="absolute bottom-10 left-10 w-96 h-96 bg-gradient-to-tr from-purple-200/30 to-cyan-200/30 rounded-full blur-3xl"></div>

    <!-- Header -->
    <header class="border-b border-purple-100 sticky top-0 z-50 bg-white/95 backdrop-blur-md shadow-sm">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3 cursor-pointer transition-transform hover:scale-105" onclick="window.location.href='dashboard.html'">
                    <div class="w-10 h-10 bg-gradient-to-br from-cyan-400 via-blue-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                        <i data-lucide="search" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold bg-gradient-to-l from-cyan-600 to-purple-600 bg-clip-text text-transparent">
                            فين
                        </h1>
                        <p class="text-xs text-gray-500 font-medium">FEEN</p>
                    </div>
                </div>

                <nav class="hidden md:flex items-center gap-8">
                    <button class="text-gray-600 hover:text-purple-600 transition-colors font-medium" onclick="window.location.href='dashboard.html'">
                        لوحة التحكم
                    </button>
                    <button class="text-gray-600 hover:text-green-600 transition-colors font-medium" onclick="window.location.href='report-found.html'">
                        تبليغ عن موجود
                    </button>
                    <button class="text-gray-600 hover:text-orange-600 transition-colors font-medium" onclick="window.location.href='report-missing.html'">
                        تبليغ عن مفقود
                    </button>
                </nav>

                <div class="flex items-center gap-3">
                    <div class="hidden md:flex items-center gap-2 text-sm">
                        <i data-lucide="user" class="w-4 h-4 text-purple-600"></i>
                        <span class="text-gray-700 font-medium" id="user-name">مستخدم</span>
                    </div>
                    <button class="px-4 py-2 text-red-600 border border-red-200 hover:bg-red-50 font-medium rounded-lg transition-colors" onclick="logout()">
                        <i data-lucide="log-out" class="w-4 h-4 ml-1 inline"></i>
                        تسجيل الخروج
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Report Details Content -->
    <div class="min-h-screen py-20 px-6 relative">
        <div class="container mx-auto max-w-4xl relative">
            <!-- Loading State -->
            <div id="loading-state" class="text-center py-20">
                <div class="w-20 h-20 bg-gradient-to-br from-indigo-400 to-purple-500 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
                    <i data-lucide="loader-2" class="w-10 h-10 text-white animate-spin"></i>
                </div>
                <h1 class="text-3xl md:text-4xl font-black text-gray-900 mb-4">
                    جاري تحميل التفاصيل
                </h1>
                <p class="text-lg text-gray-600 font-medium">
                    يرجى الانتظار...
                </p>
            </div>

            <!-- Report Details -->
            <div id="report-details" class="hidden">
                <!-- Header -->
                <div class="text-center mb-12">
                    <div id="report-icon" class="w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
                        <i data-lucide="file-text" class="w-10 h-10 text-white"></i>
                    </div>
                    <h1 id="report-title" class="text-3xl md:text-4xl font-black text-gray-900 mb-4">
                        تفاصيل البلاغ
                    </h1>
                    <p id="report-subtitle" class="text-lg text-gray-600 font-medium">
                        عرض كامل تفاصيل البلاغ
                    </p>
                </div>

                <!-- Report Content -->
                <div class="bg-white/80 backdrop-blur-md shadow-2xl border-0 rounded-2xl">
                    <div class="p-8 space-y-8">
                        <!-- Basic Information -->
                        <div class="space-y-6">
                            <div class="flex items-center gap-3 mb-6">
                                <i data-lucide="user" class="w-6 h-6 text-indigo-600"></i>
                                <h2 class="text-xl font-bold text-gray-900">
                                    المعلومات الأساسية
                                </h2>
                            </div>

                            <div class="grid md:grid-cols-2 gap-6">
                                <div class="space-y-2">
                                    <label class="text-gray-700 font-semibold">الاسم الكامل</label>
                                    <div id="report-name" class="h-12 border border-gray-200 rounded-xl bg-white/70 backdrop-blur px-4 flex items-center text-gray-900 font-medium">
                                        -
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <label class="text-gray-700 font-semibold">العمر</label>
                                    <div id="report-age" class="h-12 border border-gray-200 rounded-xl bg-white/70 backdrop-blur px-4 flex items-center text-gray-900 font-medium">
                                        -
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-2">
                                <label class="text-gray-700 font-semibold">الجنس</label>
                                <div id="report-gender" class="h-12 border border-gray-200 rounded-xl bg-white/70 backdrop-blur px-4 flex items-center text-gray-900 font-medium">
                                    -
                                </div>
                            </div>
                        </div>

                        <!-- Location Information -->
                        <div class="space-y-6 pt-6 border-t border-gray-200">
                            <div class="flex items-center gap-3 mb-6">
                                <i data-lucide="map-pin" class="w-6 h-6 text-blue-600"></i>
                                <h2 class="text-xl font-bold text-gray-900">
                                    معلومات المكان والوقت
                                </h2>
                            </div>

                            <div class="grid md:grid-cols-2 gap-6">
                                <div class="space-y-2">
                                    <label class="text-gray-700 font-semibold" id="location-label">المكان</label>
                                    <div id="report-location" class="h-12 border border-gray-200 rounded-xl bg-white/70 backdrop-blur px-4 flex items-center text-gray-900 font-medium">
                                        -
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <label class="text-gray-700 font-semibold" id="date-label">التاريخ</label>
                                    <div id="report-date" class="h-12 border border-gray-200 rounded-xl bg-white/70 backdrop-blur px-4 flex items-center text-gray-900 font-medium">
                                        -
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Information -->
                        <div class="space-y-6 pt-6 border-t border-gray-200">
                            <div class="flex items-center gap-3 mb-6">
                                <i data-lucide="file-text" class="w-6 h-6 text-purple-600"></i>
                                <h2 class="text-xl font-bold text-gray-900">
                                    معلومات إضافية
                                </h2>
                            </div>

                            <div class="space-y-4">
                                <div class="space-y-2">
                                    <label class="text-gray-700 font-semibold">الوصف</label>
                                    <div id="report-description" class="border border-gray-200 rounded-xl bg-white/70 backdrop-blur px-4 py-3 text-gray-900 font-medium min-h-[80px] flex items-center">
                                        -
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <label class="text-gray-700 font-semibold">معلومات التواصل</label>
                                    <div id="report-contact" class="h-12 border border-gray-200 rounded-xl bg-white/70 backdrop-blur px-4 flex items-center text-gray-900 font-medium">
                                        -
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Photo Section -->
                        <div class="space-y-6 pt-6 border-t border-gray-200">
                            <div class="flex items-center gap-3 mb-6">
                                <i data-lucide="camera" class="w-6 h-6 text-cyan-600"></i>
                                <h2 class="text-xl font-bold text-gray-900">الصورة</h2>
                            </div>

                            <div class="space-y-2">
                                <div id="report-photo" class="border border-gray-200 rounded-xl bg-white/70 backdrop-blur p-8 text-center">
                                    <i data-lucide="image" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                                    <p class="text-gray-600 font-medium">
                                        لا توجد صورة متاحة
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Report Status -->
                        <div class="space-y-6 pt-6 border-t border-gray-200">
                            <div class="flex items-center gap-3 mb-6">
                                <i data-lucide="info" class="w-6 h-6 text-green-600"></i>
                                <h2 class="text-xl font-bold text-gray-900">حالة البلاغ</h2>
                            </div>

                            <div class="flex items-center gap-4">
                                <div id="report-status" class="px-4 py-2 font-medium rounded-full text-sm">
                                    نشط
                                </div>
                                <div class="text-sm text-gray-600">
                                    <span id="report-created-date">تاريخ الإنشاء: -</span>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="pt-6 border-t border-gray-200">
                            <div class="flex flex-col sm:flex-row gap-4">
                                <button 
                                    id="view-matches-btn"
                                    class="flex-1 bg-gradient-to-l from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all py-4"
                                >
                                    <span class="flex items-center justify-center gap-2">
                                        <i data-lucide="users" class="w-5 h-5"></i>
                                        عرض التطابقات
                                    </span>
                                </button>
                                <button 
                                    id="delete-report-btn"
                                    class="flex-1 bg-gradient-to-l from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all py-4"
                                >
                                    <span class="flex items-center justify-center gap-2">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                                        حذف البلاغ
                                    </span>
                                </button>
                                <button 
                                    onclick="window.location.href='dashboard.html'"
                                    class="flex-1 border border-gray-300 text-gray-700 hover:bg-gray-50 font-bold rounded-xl py-4 transition-all"
                                >
                                    <span class="flex items-center justify-center gap-2">
                                        <i data-lucide="arrow-right" class="w-5 h-5"></i>
                                        العودة للوحة التحكم
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error State -->
            <div id="error-state" class="hidden text-center py-20">
                <div class="w-20 h-20 bg-gradient-to-br from-red-400 to-pink-500 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
                    <i data-lucide="alert-circle" class="w-10 h-10 text-white"></i>
                </div>
                <h1 class="text-3xl md:text-4xl font-black text-gray-900 mb-4">
                    خطأ في تحميل البلاغ
                </h1>
                <p class="text-lg text-gray-600 font-medium mb-8">
                    لم نتمكن من تحميل تفاصيل البلاغ
                </p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button onclick="window.location.reload()" class="bg-gradient-to-l from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all px-8 py-4">
                        <i data-lucide="refresh-cw" class="w-5 h-5 ml-2 inline"></i>
                        إعادة المحاولة
                    </button>
                    <button onclick="window.location.href='dashboard.html'" class="border border-gray-300 text-gray-700 hover:bg-gray-50 font-bold rounded-xl px-8 py-4 transition-all">
                        العودة للوحة التحكم
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gradient-to-br from-gray-800 via-gray-900 to-black text-white py-16">
        <div class="container mx-auto px-6">
            <div class="max-w-4xl mx-auto">
                <div class="grid md:grid-cols-3 gap-8">
                    <div>
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 bg-gradient-to-br from-cyan-400 via-purple-500 to-pink-500 rounded-xl flex items-center justify-center shadow-lg">
                                <i data-lucide="search" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-black bg-gradient-to-l from-cyan-400 to-purple-400 bg-clip-text text-transparent">
                                    فين
                                </h3>
                                <p class="text-xs text-gray-400 font-medium">FEEN</p>
                            </div>
                        </div>
                        <p class="text-gray-300 text-sm font-medium leading-relaxed">
                            منصة مفتوحة المصدر لمساعدة العائلات في العثور على أفرادها
                            المفقودين باستخدام أحدث التقنيات
                        </p>
                    </div>

                    <div>
                        <h4 class="font-bold mb-6 text-white text-lg">روابط سريعة</h4>
                        <ul class="space-y-3 text-sm">
                            <li>
                                <a href="#about" class="text-gray-300 hover:text-cyan-400 transition-colors font-medium">
                                    من نحن
                                </a>
                            </li>
                            <li>
                                <a href="#how-it-works" class="text-gray-300 hover:text-purple-400 transition-colors font-medium">
                                    كيف يعمل
                                </a>
                            </li>
                            <li>
                                <a href="#faq" class="text-gray-300 hover:text-pink-400 transition-colors font-medium">
                                    الأسئلة الشائعة
                                </a>
                            </li>
                            <li>
                                <a href="#privacy" class="text-gray-300 hover:text-green-400 transition-colors font-medium">
                                    سياسة الخصوصية
                                </a>
                            </li>
                        </ul>
                    </div>

                    <div>
                        <h4 class="font-bold mb-6 text-white text-lg">تواصل معنا</h4>
                        <div class="space-y-4 text-sm">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-green-500/20 rounded-xl flex items-center justify-center">
                                    <i data-lucide="phone" class="w-4 h-4 text-green-400"></i>
                                </div>
                                <span class="text-gray-300 font-medium">
                                    +966 50 123 4567
                                </span>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-blue-500/20 rounded-xl flex items-center justify-center">
                                    <i data-lucide="mail" class="w-4 h-4 text-blue-400"></i>
                                </div>
                                <span class="text-gray-300 font-medium">
                                    info@feen.org
                                </span>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-purple-500/20 rounded-xl flex items-center justify-center">
                                    <i data-lucide="map-pin" class="w-4 h-4 text-purple-400"></i>
                                </div>
                                <span class="text-gray-300 font-medium">
                                    الرياض، السعودية
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="border-t border-gray-700 mt-12 pt-8 text-center text-sm text-gray-400">
                    <p class="font-medium">
                        &copy; 2024 فين. جميع الحقوق محفوظة. مشروع مفتوح المصدر
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="js/notifications.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/config.js" type="module"></script>
    <script type="module">
        // Import BASE_URL from config
        import { BASE_URL } from './js/config.js';
        
        // Fallback URL in case config fails to load
        const API_BASE_URL = BASE_URL || '/api';
        
        // Initialize Lucide icons
        lucide.createIcons();

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const reportId = urlParams.get('id');
        const reportType = urlParams.get('type'); // 'found' or 'missing'

        // Initialize authentication for dashboard
        if (!initDashboardAuth()) {
            // Stop execution if not authenticated
            throw new Error('Authentication required');
        }

        // Update user name display
        updateUserNameDisplay('user-name');

        // Format date for display
        function formatDateTime(dateString) {
            if (!dateString) return 'غير محدد';
            
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ar-SA', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return 'غير محدد';
            }
        }

        // Fetch report details
        async function fetchReportDetails() {
            if (!reportId || !reportType) {
                showError('معرف البلاغ مفقود', 'يرجى العودة للوحة التحكم');
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);
                return null;
            }

            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                showError('خطأ في المصادقة', 'يرجى تسجيل الدخول مرة أخرى');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return null;
            }

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                const endpoint = reportType === 'found' ? 'found' : 'lost';
                const response = await fetch(`${API_BASE_URL}/${endpoint}/${reportId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (response.ok) {
                    const report = await response.json();
                    return report;
                } else {
                    console.error('Failed to fetch report:', response.status);
                    return null;
                }
            } catch (error) {
                console.error('Error fetching report details:', error);
                return null;
            }
        }

        // Fetch photo for a report
        async function fetchReportPhoto(reportId, reportType) {
            const authToken = localStorage.getItem('authToken');
            if (!authToken) return null;

            try {
                const endpoint = reportType === 'found' ? 'found' : 'lost';
                const response = await fetch(`${API_BASE_URL}/${endpoint}/${reportId}/photo`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    return URL.createObjectURL(blob);
                } else {
                    console.error('Failed to fetch photo:', response.status);
                    return null;
                }
            } catch (error) {
                console.error('Error fetching photo:', error);
                return null;
            }
        }

        // Render report details
        async function renderReportDetails(report) {
            // Update page title and icon based on report type
            const isFound = reportType === 'found';
            const iconElement = document.getElementById('report-icon');
            const titleElement = document.getElementById('report-title');
            const subtitleElement = document.getElementById('report-subtitle');

            if (isFound) {
                iconElement.className = 'w-20 h-20 bg-gradient-to-br from-green-400 to-emerald-500 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg';
                iconElement.innerHTML = '<i data-lucide="search" class="w-10 h-10 text-white"></i>';
                titleElement.textContent = 'تفاصيل الشخص الموجود';
                subtitleElement.textContent = 'عرض تفاصيل الشخص الذي تم العثور عليه';
            } else {
                iconElement.className = 'w-20 h-20 bg-gradient-to-br from-orange-400 to-red-500 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg';
                iconElement.innerHTML = '<i data-lucide="alert-circle" class="w-10 h-10 text-white"></i>';
                titleElement.textContent = 'تفاصيل الشخص المفقود';
                subtitleElement.textContent = 'عرض تفاصيل الشخص المفقود';
            }

            // Update basic information
            document.getElementById('report-name').textContent = report.name || 'غير محدد';
            document.getElementById('report-age').textContent = report.age ? `${report.age} سنة` : 'غير محدد';
            document.getElementById('report-gender').textContent = report.gender || 'غير محدد';

            // Update location information
            const locationLabel = document.getElementById('location-label');
            const locationElement = document.getElementById('report-location');
            const dateLabel = document.getElementById('date-label');
            const dateElement = document.getElementById('report-date');

            if (isFound) {
                locationLabel.textContent = 'مكان العثور';
                locationElement.textContent = report.foundLocation || 'غير محدد';
                dateLabel.textContent = 'تاريخ العثور';
                dateElement.textContent = formatDateTime(report.foundDate);
            } else {
                locationLabel.textContent = 'آخر مكان شوهد فيه';
                locationElement.textContent = report.lastSeen || 'غير محدد';
                dateLabel.textContent = 'تاريخ آخر مشاهدة';
                dateElement.textContent = formatDateTime(report.lastSeenDate);
            }

            // Update additional information
            document.getElementById('report-description').textContent = report.description || 'لا توجد وصف إضافي';
            document.getElementById('report-contact').textContent = report.contactInfo || 'غير محدد';

            // Update photo if available
            const photoElement = document.getElementById('report-photo');
            if (report.photo) {
                // Fetch and display photo
                try {
                    const photoUrl = await fetchReportPhoto(reportId, reportType);
                    if (photoUrl) {
                        photoElement.innerHTML = `
                            <div class="w-48 h-48 mx-auto mb-4">
                                <img src="${photoUrl}" alt="صورة الشخص" class="w-full h-full object-cover rounded-lg shadow-lg">
                            </div>
                            <p class="text-gray-600 font-medium">صورة الشخص</p>
                        `;
                    } else {
                        photoElement.innerHTML = `
                            <i data-lucide="image" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                            <p class="text-gray-600 font-medium">لا يمكن تحميل الصورة</p>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading photo:', error);
                    photoElement.innerHTML = `
                        <i data-lucide="image" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                        <p class="text-gray-600 font-medium">خطأ في تحميل الصورة</p>
                    `;
                }
            } else {
                photoElement.innerHTML = `
                    <i data-lucide="image" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                    <p class="text-gray-600 font-medium">لا توجد صورة متاحة</p>
                `;
            }

            // Update status and creation date
            document.getElementById('report-status').textContent = 'نشط';
            document.getElementById('report-created-date').textContent = `تاريخ الإنشاء: ${formatDateTime(report.createdAt)}`;

            // Update view matches button
            const viewMatchesButton = document.getElementById('view-matches-btn');
            viewMatchesButton.onclick = () => {
                window.location.href = `report-matches.html?id=${reportId}&type=${reportType}`;
            };

            // Update delete button
            const deleteButton = document.getElementById('delete-report-btn');
            deleteButton.onclick = () => {
                if (confirm('هل أنت متأكد من حذف هذا البلاغ؟')) {
                    // TODO: Implement delete API call
                    showSuccess('تم بنجاح!', 'تم حذف البلاغ بنجاح');
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 1500);
                }
            };

            // Re-initialize icons
            lucide.createIcons();
        }

        // Initialize page
        async function initializePage() {
            // Show loading state
            document.getElementById('loading-state').classList.remove('hidden');
            document.getElementById('report-details').classList.add('hidden');
            document.getElementById('error-state').classList.add('hidden');

            // Fetch report details
            const report = await fetchReportDetails();

            if (report) {
                // Hide loading, show details
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('report-details').classList.remove('hidden');
                renderReportDetails(report);
            } else {
                // Hide loading, show error
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('error-state').classList.remove('hidden');
            }
        }

        // Initialize page when DOM is loaded
        initializePage();
    </script>
</body>
</html> 